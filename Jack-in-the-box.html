<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸª Î•ÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÏŒ: Î¤Î±Î»Î¬Î½Ï„Ï‰ÏƒÎ· - ÎšÏÎ¿ÏÏƒÎ· - Î‘Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ· - Î’Î¿Î»Î®</title>
  <style>
    :root {
      --bg-dark: #0a0a1a;
      --bg-gradient: linear-gradient(135deg, #1a1a3a 0%, #2d1f4a 100%);
      --accent-gold: #FFD700;
      --accent-cyan: #4ECDC4;
      --accent-red: #FF6B6B;
      --accent-green: #7ED321;
      --accent-purple: #9B59B6;
      --accent-orange: #f39c12;
      --text-light: rgba(240, 246, 252, 0.95);
      --muted: rgba(240, 246, 252, 0.7);
      --panel-bg: rgba(20, 20, 40, 0.95);
      --panel-border: rgba(255, 255, 255, 0.15);
      --success: #2ecc71;
      --error: #e74c3c;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-light);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 12px;
      min-height: 100vh;
    }
    
    @media (max-width: 1000px) {
      .app { grid-template-columns: 1fr; }
      .side-panel { max-height: 50vh; overflow-y: auto; }
    }
    
    .canvas-container {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 10px;
      position: relative;
    }
    
    canvas {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      background: linear-gradient(180deg, #0d0d25 0%, #1a1a35 100%);
    }
    
    .phase-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
    }
    
    .phase-box {
      background: rgba(0,0,0,0.85);
      padding: 12px 18px;
      border-radius: 12px;
      border: 2px solid var(--accent-cyan);
    }
    
    .phase-box .label { color: var(--muted); font-size: 11px; }
    .phase-box .value { color: var(--accent-cyan); font-weight: bold; font-size: 15px; }
    
    .score-box {
      background: rgba(0,0,0,0.85);
      padding: 12px 18px;
      border-radius: 12px;
      border: 2px solid var(--accent-gold);
    }
    .score-box .label { color: var(--muted); font-size: 11px; }
    .score-box .value { color: var(--accent-gold); font-weight: bold; font-size: 18px; }
    
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .card {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 14px;
    }
    
    .card h3 {
      color: var(--accent-cyan);
      font-size: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .data-item {
      background: rgba(0,0,0,0.3);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .data-item .label { color: var(--muted); font-size: 11px; }
    .data-item .value { color: var(--text-light); font-weight: bold; font-size: 14px; }
    
    .quiz-card {
      border: 2px solid var(--accent-purple);
      background: rgba(155, 89, 182, 0.1);
    }
    
    .quiz-card h3 { color: var(--accent-purple); }
    
    .quiz-question {
      background: rgba(0,0,0,0.4);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .quiz-question code {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--accent-gold);
    }
    
    .quiz-input-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .quiz-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.4);
      color: var(--text-light);
      font-size: 16px;
      font-weight: bold;
    }
    
    .quiz-input:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    
    .quiz-unit {
      color: var(--muted);
      font-size: 14px;
      min-width: 50px;
    }
    
    .quiz-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .quiz-btn.check {
      background: linear-gradient(135deg, var(--accent-purple), #8e44ad);
      color: white;
    }
    
    .quiz-btn.hint {
      background: linear-gradient(135deg, var(--accent-orange), #e67e22);
      color: white;
    }
    
    .quiz-btn.reveal {
      background: linear-gradient(135deg, var(--accent-red), #c0392b);
      color: white;
    }
    
    .quiz-btn.next {
      background: linear-gradient(135deg, var(--accent-green), #27ae60);
      color: white;
    }
    
    .quiz-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .quiz-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .feedback {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .feedback.correct {
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid var(--success);
      color: #a9dfbf;
    }
    
    .feedback.wrong {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--error);
      color: #f5b7b1;
    }
    
    .feedback.info {
      background: rgba(52, 152, 219, 0.2);
      border: 1px solid #3498db;
      color: #aed6f1;
    }
    
    .hint-box {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }
    
    .hint-box h4 {
      color: var(--accent-gold);
      font-size: 13px;
      margin-bottom: 8px;
    }
    
    .hint-box p {
      font-size: 13px;
      color: var(--text-light);
      margin: 4px 0;
      line-height: 1.6;
    }
    
    .hint-box .formula {
      font-family: "Times New Roman", serif;
      font-size: 15px;
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
      margin: 6px 0;
    }
    
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .btn {
      flex: 1;
      min-width: 100px;
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-cyan), #3498db);
      color: #0a0a1a;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-light);
    }
    
    .btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .progress-container {
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .progress-step {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      color: var(--muted);
    }
    
    .progress-step.active {
      background: var(--accent-purple);
      border-color: var(--accent-purple);
      color: white;
    }
    
    .progress-step.done {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: white;
    }
    
    .progress-bar {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
      border-radius: 2px;
      transition: width 0.5s;
    }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 20px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h2 {
      color: var(--accent-gold);
      font-size: 24px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .modal-section {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
    }
    
    .modal-section h4 {
      color: var(--accent-cyan);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .modal-section p {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
    
    .hidden { display: none !important; }
    
    .attempts-info {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      padding: 6px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    
    .attempts-info strong { color: var(--accent-gold); }
  </style>
</head>
<body>
  <div class="app">
    <!-- Canvas -->
    <div class="canvas-container">
      <canvas id="canvas" width="800" height="600"></canvas>
      <div class="phase-overlay">
        <div class="phase-box">
          <div class="label">Î¦Î‘Î£Î—</div>
          <div class="value" id="phaseDisplay">Î‘Î½Î±Î¼Î¿Î½Î®</div>
        </div>
        <div class="score-box">
          <div class="label">Î’Î‘Î˜ÎœÎŸÎ™</div>
          <div class="value" id="scoreDisplay">0</div>
        </div>
      </div>
    </div>
    
    <!-- Side Panel -->
    <div class="side-panel">
      <!-- Progress -->
      <div class="card">
        <div class="progress-container">
          <div class="progress-steps">
            <div class="progress-step" id="step1">1</div>
            <div class="progress-step" id="step2">2</div>
            <div class="progress-step" id="step3">3</div>
            <div class="progress-step" id="step4">4</div>
            <div class="progress-step" id="step5">5</div>
            <div class="progress-step" id="step6">6</div>
            <div class="progress-step" id="step7">7</div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
        <div style="text-align: center; color: var(--muted); font-size: 12px;">
          <span id="progressText">Î•ÏÏÏ„Î·Î¼Î± 1 Î±Ï€ÏŒ 7</span>
        </div>
      </div>
      
      <!-- Given Data -->
      <div class="card">
        <h3>ğŸ“‹ Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î†ÏƒÎºÎ·ÏƒÎ·Ï‚</h3>
        <div class="data-grid">
          <div class="data-item">
            <div class="label">mâ‚ (Î´Î¯ÏƒÎºÎ¿Ï‚)</div>
            <div class="value">0.1 kg</div>
          </div>
          <div class="data-item">
            <div class="label">mâ‚‚ (ÎºÎµÏ†Î¬Î»Î¹)</div>
            <div class="value">0.1 kg</div>
          </div>
          <div class="data-item">
            <div class="label">mâ‚ƒ (Î²ÏŒÎ»Î¿Ï‚)</div>
            <div class="value">0.4 kg</div>
          </div>
          <div class="data-item">
            <div class="label">d (Î˜.Î™.â†’Î¸.Ï†.Î¼.)</div>
            <div class="value">0.1 m</div>
          </div>
          <div class="data-item">
            <div class="label">Aâ‚€ (Ï€Î»Î¬Ï„Î¿Ï‚)</div>
            <div class="value">0.5 m</div>
          </div>
          <div class="data-item">
            <div class="label">Ï‰, g</div>
            <div class="value">10, 10</div>
          </div>
        </div>
      </div>
      
      <!-- Quiz Card -->
      <div class="card quiz-card" id="quizCard">
        <h3>â“ <span id="quizTitle">Î•ÏÏÏ„Î·Î¼Î±</span></h3>
        <div class="quiz-question" id="quizQuestion"></div>
        
        <div class="quiz-input-row">
          <input type="number" class="quiz-input" id="quizInput" step="0.01" placeholder="Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·">
          <span class="quiz-unit" id="quizUnit">m/s</span>
        </div>
        
        <button class="quiz-btn check" id="btnCheck">âœ“ ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</button>
        <button class="quiz-btn hint hidden" id="btnHint">ğŸ’¡ Î˜Î­Î»Ï‰ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</button>
        <button class="quiz-btn reveal hidden" id="btnReveal">ğŸ‘ Î”ÎµÎ¯Î¾Îµ Ï„Î·Î½ Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· (-10 Î²Î±Î¸Î¼Î¿Î¯)</button>
        <button class="quiz-btn next hidden" id="btnNext">â–¶ Î•Ï€ÏŒÎ¼ÎµÎ½Î¿</button>
        
        <div class="feedback hidden" id="feedback"></div>
        
        <div class="hint-box hidden" id="hintBox">
          <h4>ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</h4>
          <div id="hintContent"></div>
        </div>
        
        <div class="attempts-info" id="attemptsInfo">
          Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚: <strong>0</strong> | ÎœÎµÏ„Î¬ Î±Ï€ÏŒ Î»Î¬Î¸Î¿Ï‚ â†’ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·
        </div>
      </div>
      
      <!-- Controls -->
      <div class="card">
        <h3>ğŸ® ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</h3>
        <div class="btn-row">
          <button class="btn btn-primary" id="btnStart">â–¶ Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±</button>
          <button class="btn btn-secondary" id="btnReset">â†º Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
        </div>
        <p style="margin-top: 10px; font-size: 11px; color: var(--muted); text-align: center;">
          ğŸ¢ ÎšÎ¯Î½Î·ÏƒÎ· ÏƒÎµ <strong style="color: var(--accent-cyan);">Î‘Î¡Î“Î— Î¤Î‘Î§Î¥Î¤Î—Î¤Î‘</strong> (Ã—0.12)
        </p>
      </div>
    </div>
  </div>
  
  <!-- Intro Modal -->
  <div class="modal-overlay" id="introModal">
    <div class="modal">
      <h2>ğŸª Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ· Î•ÎºÏ„ÏŒÎ¾ÎµÏ…ÏƒÎ· ÎšÎ»ÏŒÎ¿Ï…Î½</h2>
      <p style="text-align: center; color: var(--muted); margin-bottom: 16px;">
        Î¤Î±Î»Î¬Î½Ï„Ï‰ÏƒÎ· â€¢ Î•Î»Î±ÏƒÏ„Î¹ÎºÎ® ÎšÏÎ¿ÏÏƒÎ· â€¢ Î‘Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ· â€¢ ÎšÎ±Ï„Î±ÎºÏŒÏÏ…Ï†Î· Î’Î¿Î»Î®
      </p>
      
      <div class="modal-section">
        <h4>ğŸ“– Î— Î†ÏƒÎºÎ·ÏƒÎ·</h4>
        <p>
          Î”ÏÎ¿ Ï€Î±ÏÎ¬Î»Î»Î·Î»Î± ÎµÎ»Î±Ï„Î®ÏÎ¹Î± ÏƒÏ„Î·ÏÎ¯Î¶Î¿Ï…Î½ Î´Î¯ÏƒÎºÎ¿ Î¼Îµ ÎºÎµÏ†Î¬Î»Î¹ ÎºÎ»ÏŒÎ¿Ï…Î½. 
          Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï„Î±Î»Î±Î½Ï„ÏÎ½ÎµÏ„Î±Î¹ ÎºÎ±Î¹ ÏƒÏ„Î· Î˜.Î™. ÏƒÏ…Î³ÎºÏÎ¿ÏÎµÏ„Î±Î¹ Î¼Îµ Î²ÏŒÎ»Î¿ Ï€Î¿Ï… Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ ÎµÎºÎµÎ¯.
          ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·, Ï„Î¿ ÎºÎµÏ†Î¬Î»Î¹ Î±Ï€Î¿ÎºÎ¿Î»Î»Î¬Ï„Î±Î¹ ÎºÎ±Î¹ ÏƒÏ…Î½Î±Î½Ï„Î¬ Ï„Î¿Î½ Î²ÏŒÎ»Î¿!
        </p>
      </div>
      
      <div class="modal-section">
        <h4>ğŸ¯ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</h4>
        <p>
          â€¢ <strong style="color: var(--accent-green);">+20 Î²Î±Î¸Î¼Î¿Î¯</strong> Î³Î¹Î± ÎºÎ¬Î¸Îµ ÏƒÏ‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·<br>
          â€¢ <strong style="color: var(--accent-orange);">Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î·</strong> Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Î»Î¬Î¸Î¿Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Ï€Î¿Î¹Î½Î®)<br>
          â€¢ <strong style="color: var(--accent-red);">-10 Î²Î±Î¸Î¼Î¿Î¯</strong> Î±Î½ Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·<br><br>
          ÎœÎ­Î³Î¹ÏƒÏ„Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±: <strong>140 Î²Î±Î¸Î¼Î¿Î¯</strong> (7 ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚)
        </p>
      </div>
      
      <button class="btn btn-primary" style="width: 100%; margin-top: 10px; padding: 14px; font-size: 16px;" id="btnStartGame">
        ğŸš€ Î‘Ï‚ ÎÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î¼Îµ!
      </button>
    </div>
  </div>
  
  <!-- End Modal -->
  <div class="modal-overlay hidden" id="endModal">
    <div class="modal">
      <h2 id="endTitle">ğŸ‰ Î¤Î­Î»Î¿Ï‚!</h2>
      <div style="text-align: center; font-size: 60px; margin: 20px 0;" id="endMedal">ğŸ†</div>
      
      <div class="modal-section">
        <h4>ğŸ“Š Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</h4>
        <div id="endResults"></div>
      </div>
      
      <div class="modal-section">
        <h4>ğŸ“ Î£ÏÎ½Î¿ÏˆÎ· Î¦Ï…ÏƒÎ¹ÎºÎ®Ï‚</h4>
        <div id="endAnalysis"></div>
      </div>
      
      <button class="btn btn-primary" style="width: 100%; margin-top: 10px; padding: 14px;" id="btnPlayAgain">
        ğŸ”„ Î Î±Î¯Î¾Îµ ÎÎ±Î½Î¬
      </button>
    </div>
  </div>

<script>
/* =====================================================
   PHYSICS CONSTANTS
===================================================== */
const M1 = 0.1, M2 = 0.1, M3 = 0.4;
const M_SYS = M1 + M2;
const D = 0.1;
const G = 10;
const A0 = 0.5;
const K_TOTAL = (M_SYS * G) / D;
const OMEGA = Math.sqrt(K_TOTAL / M_SYS);

// Î˜ÎµÏ‰ÏÎ·Ï„Î¹ÎºÎ­Ï‚ Ï„Î¹Î¼Î­Ï‚
const U0 = OMEGA * A0;
const U1_AFTER = ((M_SYS - M3) / (M_SYS + M3)) * U0;
const U3_AFTER = (2 * M_SYS / (M_SYS + M3)) * U0;
const A1 = Math.abs(U1_AFTER) / OMEGA;
const T_DETACH = (Math.PI + Math.asin(D / A1)) / OMEGA;
const V_DETACH = OMEGA * Math.sqrt(A1*A1 - D*D);

// Î£Ï…Î½Î¬Î½Ï„Î·ÏƒÎ·
const Y_BALL_AT_DETACH = U3_AFTER * T_DETACH - 0.5 * G * T_DETACH * T_DETACH;
const V_BALL_AT_DETACH = U3_AFTER - G * T_DETACH;
const TAU_MEET = (Y_BALL_AT_DETACH - D) / (V_DETACH - V_BALL_AT_DETACH);
const Y_MEET = D + V_DETACH * TAU_MEET - 0.5 * G * TAU_MEET * TAU_MEET;

/* =====================================================
   RENDERING
===================================================== */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const PPM = 320;
const CX = W / 2;
const FLOOR_Y = H - 50;
const EQ_Y = FLOOR_Y - 200;
const NAT_Y = EQ_Y - D * PPM;

/* =====================================================
   GAME STATE
===================================================== */
let state = {
  // Animation state
  animState: 'idle', // idle, to_equilibrium, at_collision, post_collision, to_detach, after_detach, to_meeting
  
  t: 0,
  tCollision: null,
  tDetach: null,
  
  // Positions
  x: -A0,
  v: 0,
  amplitude: A0,
  
  // Ball (Î²ÏŒÎ»Î¿Ï‚) - Î Î‘ÎÎ© Î±Ï€ÏŒ ÎºÎ»ÏŒÎ¿Ï…Î½, Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ ÏƒÏ„Î· Î˜.Î™.
  ballY: 0,      // ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Î˜.Î™.
  ballV: 0,
  ballActive: false, // Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ· ÎºÎ¹Î½ÎµÎ¯Ï„Î±Î¹
  
  // Head (ÎºÎµÏ†Î¬Î»Î¹) - Î¼ÎµÏ„Î¬ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·
  headY: 0,
  headV: 0,
  headDetached: false,
  
  // Disk - Î¼ÎµÏ„Î¬ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·
  diskX: 0,
  diskV: 0,
  
  // Quiz
  currentQuestion: 0,
  score: 0,
  attempts: 0,
  hintShown: false,
  answerRevealed: false,
  
  slowMotion: 0.12,
  running: false
};

/* =====================================================
   QUIZ QUESTIONS
===================================================== */
const QUESTIONS = [
  {
    id: 'u0',
    title: 'Î’1: Î¤Î±Ï‡ÏÏ„Î·Ï„Î± Ï€ÏÎ¹Î½ ÎºÏÎ¿ÏÏƒÎ·',
    question: `Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï†Ï„Î¬Î½ÎµÎ¹ ÏƒÏ„Î· <strong>Î˜Î­ÏƒÎ· Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚</strong> ÎºÎ¹Î½Î¿ÏÎ¼ÎµÎ½Î¿ Ï€ÏÎ¿Ï‚ Ï„Î± Ï€Î¬Î½Ï‰.<br>
               Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î± <code>uâ‚€</code> Î±ÎºÏÎ¹Î²ÏÏ‚ <strong>Ï€ÏÎ¹Î½</strong> Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·;`,
    unit: 'm/s',
    answer: U0,
    tolerance: 0.15,
    hint: `<p><strong>Î£Ï„Î· Î˜.Î™. Î· Î±Ï€Î¿Î¼Î¬ÎºÏÏ…Î½ÏƒÎ· ÎµÎ¯Î½Î±Î¹ x = 0</strong></p>
           <p class="formula">u = Ï‰ Â· âˆš(AÂ² - xÂ²)</p>
           <p>ÎŒÏ„Î±Î½ x = 0, Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î± Î³Î¯Î½ÎµÏ„Î±Î¹ Î¼Î­Î³Î¹ÏƒÏ„Î·:</p>
           <p class="formula">uâ‚€ = Ï‰ Â· Aâ‚€</p>
           <p>Î‘Î½Ï„Î¹ÎºÎ±Ï„Î­ÏƒÏ„Î·ÏƒÎµ: Ï‰ = 10 rad/s, Aâ‚€ = 0.5 m</p>`,
    targetState: 'at_collision',
    setupState: () => {
      state.animState = 'to_equilibrium';
      state.t = 0;
      state.x = -A0;
      state.v = 0;
      state.ballActive = false;
      state.ballY = 0;
      state.headDetached = false;
    },
    freezeCondition: () => state.x >= -0.01 && state.v > 0,
    onFreeze: () => {
      state.x = 0;
      state.v = U0;
      state.animState = 'at_collision';
    }
  },
  {
    id: 'u1',
    title: 'Î’2Î±: Î¤Î±Ï‡ÏÏ„Î·Ï„Î± ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î¼ÎµÏ„Î¬',
    question: `Î— ÎºÏÎ¿ÏÏƒÎ· ÎµÎ¯Î½Î±Î¹ <strong>ÎµÎ»Î±ÏƒÏ„Î¹ÎºÎ®</strong>. ÎŸ Î²ÏŒÎ»Î¿Ï‚ Î®Ï„Î±Î½ Î±ÎºÎ¯Î½Î·Ï„Î¿Ï‚.<br>
               Î Î¿Î¹Î± Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î± <code>uâ‚'</code> Ï„Î¿Ï… ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ <strong>Î¼ÎµÏ„Î¬</strong> Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·;<br>
               <small>(Î‘ÏÎ½Î·Ï„Î¹ÎºÏŒ = Ï€ÏÎ¿Ï‚ Ï„Î± ÎºÎ¬Ï„Ï‰)</small>`,
    unit: 'm/s',
    answer: U1_AFTER,
    tolerance: 0.15,
    hint: `<p><strong>Î¤ÏÏ€Î¿Ï‚ ÎµÎ»Î±ÏƒÏ„Î¹ÎºÎ®Ï‚ ÎºÏÎ¿ÏÏƒÎ·Ï‚:</strong></p>
           <p class="formula">uâ‚' = [(mâ‚+mâ‚‚) - mâ‚ƒ] / [(mâ‚+mâ‚‚) + mâ‚ƒ] Ã— uâ‚€</p>
           <p>ÎœÎµ mâ‚+mâ‚‚ = 0.2 kg ÎºÎ±Î¹ mâ‚ƒ = 0.4 kg:</p>
           <p class="formula">uâ‚' = (0.2 - 0.4) / (0.2 + 0.4) Ã— uâ‚€</p>
           <p>Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¿ ÎºÎ»Î¬ÏƒÎ¼Î± ÎºÎ±Î¹ Ï€Î¿Î»Î»Î±Ï€Î»Î±ÏƒÎ¯Î±ÏƒÎµ Î¼Îµ uâ‚€.</p>`,
    targetState: 'post_collision',
    setupState: () => {
      // Snapshot Î±Î¼Î­ÏƒÏ‰Ï‚ Î¼ÎµÏ„Î¬ ÎºÏÎ¿ÏÏƒÎ·
      state.x = 0;
      state.v = U1_AFTER;
      state.ballY = 0;
      state.ballV = U3_AFTER;
      state.ballActive = true;
      state.tCollision = 0;
      state.t = 0;
      state.animState = 'post_collision';
    },
    freezeCondition: () => true, // Freeze immediately for this question
    onFreeze: () => {}
  },
  {
    id: 'u3',
    title: 'Î’2Î²: Î¤Î±Ï‡ÏÏ„Î·Ï„Î± Î²ÏŒÎ»Î¿Ï… Î¼ÎµÏ„Î¬',
    question: `Î Î¿Î¹Î± Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î± <code>uâ‚ƒ'</code> Ï„Î¿Ï… Î²ÏŒÎ»Î¿Ï… <strong>Î¼ÎµÏ„Î¬</strong> Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·;<br>
               <small>(Î˜ÎµÏ„Î¹ÎºÏŒ = Ï€ÏÎ¿Ï‚ Ï„Î± Ï€Î¬Î½Ï‰)</small>`,
    unit: 'm/s',
    answer: U3_AFTER,
    tolerance: 0.15,
    hint: `<p><strong>Î¤ÏÏ€Î¿Ï‚ Î³Î¹Î± Ï„Î¿Î½ Î²ÏŒÎ»Î¿ (Î±ÏÏ‡Î¹ÎºÎ¬ Î±ÎºÎ¯Î½Î·Ï„Î¿Ï‚):</strong></p>
           <p class="formula">uâ‚ƒ' = 2(mâ‚+mâ‚‚) / [(mâ‚+mâ‚‚) + mâ‚ƒ] Ã— uâ‚€</p>
           <p>ÎœÎµ mâ‚+mâ‚‚ = 0.2 kg ÎºÎ±Î¹ mâ‚ƒ = 0.4 kg:</p>
           <p class="formula">uâ‚ƒ' = (2 Ã— 0.2) / 0.6 Ã— uâ‚€</p>
           <p>Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ!</p>`,
    targetState: 'post_collision',
    setupState: () => {
      // ÎŠÎ´Î¹Î¿ Î¼Îµ Q2
      state.x = 0;
      state.v = U1_AFTER;
      state.ballY = 0;
      state.ballV = U3_AFTER;
      state.ballActive = true;
      state.tCollision = 0;
      state.t = 0;
      state.animState = 'post_collision';
    },
    freezeCondition: () => true,
    onFreeze: () => {}
  },
  {
    id: 'a1',
    title: 'Î“1: ÎÎ­Î¿ Ï€Î»Î¬Ï„Î¿Ï‚ Ï„Î±Î»Î¬Î½Ï„Ï‰ÏƒÎ·Ï‚',
    question: `ÎœÎµÏ„Î¬ Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·, Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Ï„Î±Î»Î±Î½Ï„ÏÎ½ÎµÏ„Î±Î¹ Î¼Îµ Î½Î­Î¿ Ï€Î»Î¬Ï„Î¿Ï‚.<br>
               Î Î¿Î¹Î¿ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ <strong>Ï€Î»Î¬Ï„Î¿Ï‚ Aâ‚</strong>;`,
    unit: 'm',
    answer: A1,
    tolerance: 0.02,
    hint: `<p><strong>Î£Ï„Î· Î˜.Î™. (x=0), ÏŒÎ»Î· Î· ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± ÎµÎ¯Î½Î±Î¹ ÎºÎ¹Î½Î·Ï„Î¹ÎºÎ®:</strong></p>
           <p class="formula">Â½mÂ·uâ‚'Â² = Â½k<sub>Î¿Î»</sub>Â·Aâ‚Â²</p>
           <p>Î›ÏÎ½Î¿Î½Ï„Î±Ï‚ Ï‰Ï‚ Ï€ÏÎ¿Ï‚ Aâ‚:</p>
           <p class="formula">Aâ‚ = |uâ‚'| / Ï‰</p>
           <p>Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ uâ‚' Ï€Î¿Ï… Î²ÏÎ®ÎºÎµÏ‚ ÎºÎ±Î¹ Ï‰ = 10 rad/s</p>`,
    targetState: 'show_amplitude',
    setupState: () => {
      // Î”ÎµÎ¯Î¾Îµ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î½Î± Ï€Î·Î³Î±Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿ Î±ÎºÏÎ±Î¯Î¿ ÎºÎ¬Ï„Ï‰
      state.tCollision = 0;
      state.t = 0;
      state.amplitude = A1;
      state.ballActive = true;
      state.animState = 'post_collision';
    },
    freezeCondition: () => {
      // Freeze ÏŒÏ„Î±Î½ Ï†Ï„Î¬ÏƒÎµÎ¹ ÏƒÏ„Î¿ Î±ÎºÏÎ±Î¯Î¿ ÎºÎ¬Ï„Ï‰
      const tPost = state.t;
      return tPost > 0.1 && state.x <= -A1 + 0.01;
    },
    onFreeze: () => {
      state.x = -A1;
      state.v = 0;
    }
  },
  {
    id: 'x_detach',
    title: 'Î“2Î±: Î˜Î­ÏƒÎ· Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚',
    question: `Î¤Î¿ ÎºÎµÏ†Î¬Î»Î¹ Î±Ï€Î¿ÎºÎ¿Î»Î»Î¬Ï„Î±Î¹ ÏŒÏ„Î±Î½ Î· ÎºÎ¬Î¸ÎµÏ„Î· Î´ÏÎ½Î±Î¼Î· N Î³Î¯Î½ÎµÎ¹ Î¼Î·Î´Î­Î½.<br>
               Î£Îµ Ï€Î¿Î¹Î± <strong>Î¸Î­ÏƒÎ· x</strong> (Î±Ï€ÏŒ Ï„Î· Î˜.Î™.) Î³Î¯Î½ÎµÏ„Î±Î¹ Î· Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·;`,
    unit: 'm',
    answer: D,
    tolerance: 0.02,
    hint: `<p><strong>Î£Ï…Î½Î¸Î®ÎºÎ· Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚:</strong> N = 0</p>
           <p>Î‘Ï€ÏŒ 2Î¿ ÎÏŒÎ¼Î¿ ÎÎµÏÏ„Ï‰Î½Î± ÏƒÏ„Î¿ ÎºÎµÏ†Î¬Î»Î¹:</p>
           <p class="formula">N - mâ‚‚g = mâ‚‚a âŸ¹ a = -g</p>
           <p>Î£Ï„Î·Î½ Î‘Î‘Î¤: a = -Ï‰Â²x, Î¬ÏÎ± -g = -Ï‰Â²x</p>
           <p><strong>Î Î¿Ï Î³Î¯Î½ÎµÏ„Î±Î¹ a = -g;</strong> Î•ÎºÎµÎ¯ Ï€Î¿Ï… F<sub>ÎµÎ»Î±Ï„</sub> = 0!</p>
           <p>Î”Î·Î»Î±Î´Î® ÏƒÏ„Î· Î¸Î­ÏƒÎ· Ï†Ï…ÏƒÎ¹ÎºÎ¿Ï Î¼Î®ÎºÎ¿Ï…Ï‚: x = d</p>`,
    targetState: 'to_detach',
    setupState: () => {
      // ÎÎµÎºÎ¯Î½Î± Î±Ï€ÏŒ Ï„Î¿ Î±ÎºÏÎ±Î¯Î¿ ÎºÎ¬Ï„Ï‰, Ï€Î®Î³Î±Î¹Î½Îµ Ï€ÏÎ¿Ï‚ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·
      state.tCollision = 0;
      state.t = 0;
      state.amplitude = A1;
      state.x = -A1;
      state.v = 0;
      state.ballActive = true;
      state.headDetached = false;
      state.animState = 'to_detach';
    },
    freezeCondition: () => {
      return state.x >= D - 0.008 && state.v > 0;
    },
    onFreeze: () => {
      state.x = D;
      state.v = V_DETACH;
    }
  },
  {
    id: 'v_detach',
    title: 'Î“2Î²: Î¤Î±Ï‡ÏÏ„Î·Ï„Î± Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚',
    question: `Î Î¿Î¹Î± Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î± <code>u<sub>Î±Ï€</sub></code> Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Ï„Î·Ï‚ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚;<br>
               <small>(ÏƒÏ„Î· Î¸Î­ÏƒÎ· x = d = 0.1 m)</small>`,
    unit: 'm/s',
    answer: V_DETACH,
    tolerance: 0.1,
    hint: `<p><strong>Î¤Î±Ï‡ÏÏ„Î·Ï„Î± ÏƒÎµ Î¸Î­ÏƒÎ· x Ï„Î·Ï‚ Î‘Î‘Î¤:</strong></p>
           <p class="formula">u = Ï‰ Â· âˆš(Aâ‚Â² - xÂ²)</p>
           <p>Î£Ï„Î· Î¸Î­ÏƒÎ· Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚ x = d:</p>
           <p class="formula">u<sub>Î±Ï€</sub> = Ï‰ Â· âˆš(Aâ‚Â² - dÂ²)</p>
           <p>Î‘Î½Ï„Î¹ÎºÎ±Ï„Î­ÏƒÏ„Î·ÏƒÎµ: Ï‰ = 10, Aâ‚ â‰ˆ 0.167 m, d = 0.1 m</p>`,
    targetState: 'at_detach',
    setupState: () => {
      // Snapshot ÏƒÏ„Î· ÏƒÏ„Î¹Î³Î¼Î® Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚
      state.x = D;
      state.v = V_DETACH;
      state.headDetached = false; // Î‘ÎºÏŒÎ¼Î± Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿Î½ Î´Î¯ÏƒÎºÎ¿ Î³Î¹Î± Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î±
      state.ballActive = true;
      // Î˜Î­ÏƒÎ· Î²ÏŒÎ»Î¿Ï… Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚
      state.ballY = Y_BALL_AT_DETACH;
      state.ballV = V_BALL_AT_DETACH;
      state.animState = 'at_detach';
    },
    freezeCondition: () => true,
    onFreeze: () => {}
  },
  {
    id: 'y_meet',
    title: 'Î”: Î˜Î­ÏƒÎ· ÏƒÏ…Î½Î¬Î½Ï„Î·ÏƒÎ·Ï‚',
    question: `ÎœÎµÏ„Î¬ Ï„Î·Î½ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·, ÎºÎµÏ†Î¬Î»Î¹ ÎºÎ±Î¹ Î²ÏŒÎ»Î¿Ï‚ ÎºÎ¹Î½Î¿ÏÎ½Ï„Î±Î¹ Ï‰Ï‚ Î²Î»Î®Î¼Î±Ï„Î±.<br>
               Î£Îµ Ï€Î¿Î¹Î¿ <strong>ÏÏˆÎ¿Ï‚ y</strong> (Î±Ï€ÏŒ Î˜.Î™.) Î¸Î± ÏƒÏ…Î½Î±Î½Ï„Î·Î¸Î¿ÏÎ½;<br>
               <small>t<sub>Î±Ï€Î¿Îº</sub> â‰ˆ 0.38s Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎºÏÎ¿ÏÏƒÎ·</small>`,
    unit: 'm',
    answer: Y_MEET,
    tolerance: 0.05,
    hint: `<p><strong>Î•Î¾Î¹ÏƒÏÏƒÎµÎ¹Ï‚ Î²Î»Î·Î¼Î¬Ï„Ï‰Î½ (Ï„ = Ï‡ÏÏŒÎ½Î¿Ï‚ Î±Ï€ÏŒ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·):</strong></p>
           <p class="formula">ÎšÎµÏ†Î¬Î»Î¹: yâ‚‚ = d + u<sub>Î±Ï€</sub>Â·Ï„ - Â½gÂ·Ï„Â²</p>
           <p class="formula">Î’ÏŒÎ»Î¿Ï‚: yâ‚ƒ = yâ‚ƒ,â‚€ + uâ‚ƒÂ·Ï„ - Â½gÂ·Ï„Â²</p>
           <p>Î¤Î± -Â½gÏ„Â² Î±Ï€Î±Î»ÎµÎ¯Ï†Î¿Î½Ï„Î±Î¹! Î†ÏÎ±:</p>
           <p class="formula">yâ‚‚ = yâ‚ƒ âŸ¹ Ï„ = (yâ‚ƒ,â‚€ - d)/(u<sub>Î±Ï€</sub> - uâ‚ƒ)</p>
           <p>Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Ï„Î¹Ï‚ Î¸Î­ÏƒÎµÎ¹Ï‚/Ï„Î±Ï‡ÏÏ„Î·Ï„ÎµÏ‚ Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚.</p>`,
    targetState: 'to_meeting',
    setupState: () => {
      // ÎÎµÎºÎ¯Î½Î± Î±Ï€ÏŒ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·, Ï€Î®Î³Î±Î¹Î½Îµ Ï€ÏÎ¿Ï‚ ÏƒÏ…Î½Î¬Î½Ï„Î·ÏƒÎ·
      state.headDetached = true;
      state.headY = D;
      state.headV = V_DETACH;
      state.diskX = D;
      state.diskV = V_DETACH;
      state.ballY = Y_BALL_AT_DETACH;
      state.ballV = V_BALL_AT_DETACH;
      state.tDetach = 0;
      state.tCollision = T_DETACH; // Ï‡ÏÏŒÎ½Î¿Ï‚ ÎºÏÎ¿ÏÏƒÎ·Ï‚->Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚
      state.t = 0;
      state.ballActive = true;
      state.animState = 'to_meeting';
    },
    freezeCondition: () => {
      return Math.abs(state.headY - state.ballY) < 0.04;
    },
    onFreeze: () => {
      state.headY = Y_MEET;
      state.ballY = Y_MEET;
      state.animState = 'meeting_done';
    }
  }
];

/* =====================================================
   DOM
===================================================== */
const qs = id => document.getElementById(id);

/* =====================================================
   QUIZ LOGIC
===================================================== */
function showQuestion(index) {
  if (index >= QUESTIONS.length) {
    endGame();
    return;
  }
  
  const q = QUESTIONS[index];
  state.currentQuestion = index;
  state.attempts = 0;
  state.hintShown = false;
  state.answerRevealed = false;
  
  qs('quizTitle').textContent = q.title;
  qs('quizQuestion').innerHTML = q.question;
  qs('quizUnit').textContent = q.unit;
  qs('quizInput').value = '';
  qs('feedback').classList.add('hidden');
  qs('hintBox').classList.add('hidden');
  qs('btnCheck').classList.remove('hidden');
  qs('btnHint').classList.add('hidden');
  qs('btnReveal').classList.add('hidden');
  qs('btnNext').classList.add('hidden');
  
  // Setup animation state for this question
  q.setupState();
  state.running = true;
  
  updateProgress(index);
  updateAttemptsInfo();
  updatePhaseDisplay();
}

function checkAnswer() {
  const q = QUESTIONS[state.currentQuestion];
  const userAnswer = parseFloat(qs('quizInput').value);
  
  if (isNaN(userAnswer)) {
    showFeedback('wrong', 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î±Î½ Î±ÏÎ¹Î¸Î¼ÏŒ!');
    return;
  }
  
  state.attempts++;
  const diff = Math.abs(userAnswer - q.answer);
  const correct = diff <= q.tolerance;
  
  if (correct) {
    if (!state.answerRevealed) {
      state.score += 20;
      qs('scoreDisplay').textContent = state.score;
    }
    showFeedback('correct', `âœ“ Î£Ï‰ÏƒÏ„Î¬! Î— Ï„Î¹Î¼Î® ÎµÎ¯Î½Î±Î¹ <strong>${q.answer.toFixed(3)} ${q.unit}</strong>`);
    
    qs(`step${state.currentQuestion + 1}`).classList.remove('active');
    qs(`step${state.currentQuestion + 1}`).classList.add('done');
    qs(`step${state.currentQuestion + 1}`).textContent = 'âœ“';
    
    qs('btnCheck').classList.add('hidden');
    qs('btnHint').classList.add('hidden');
    qs('btnReveal').classList.add('hidden');
    qs('btnNext').classList.remove('hidden');
  } else {
    showFeedback('wrong', `âœ— Î›Î¬Î¸Î¿Ï‚! Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ® ÏƒÎ¿Ï…: ${userAnswer.toFixed(2)} ${q.unit}`);
    
    if (!state.hintShown) {
      qs('btnHint').classList.remove('hidden');
    } else if (!state.answerRevealed) {
      qs('btnReveal').classList.remove('hidden');
    }
  }
  
  updateAttemptsInfo();
}

function showHint() {
  const q = QUESTIONS[state.currentQuestion];
  state.hintShown = true;
  
  qs('hintContent').innerHTML = q.hint;
  qs('hintBox').classList.remove('hidden');
  qs('btnHint').classList.add('hidden');
  qs('btnReveal').classList.remove('hidden');
  
  showFeedback('info', 'ğŸ’¡ Î”Î¹Î¬Î²Î±ÏƒÎµ Ï„Î·Î½ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î· ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬!');
}

function revealAnswer() {
  const q = QUESTIONS[state.currentQuestion];
  state.answerRevealed = true;
  state.score = Math.max(0, state.score - 10);
  qs('scoreDisplay').textContent = state.score;
  
  showFeedback('info', `ğŸ‘ Î— ÏƒÏ‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎµÎ¯Î½Î±Î¹: <strong>${q.answer.toFixed(3)} ${q.unit}</strong><br>
                        <small>(-10 Î²Î±Î¸Î¼Î¿Î¯ Î³Î¹Î± Î±Ï€Î¿ÎºÎ¬Î»Ï…ÏˆÎ·)</small>`);
  
  qs('btnCheck').classList.add('hidden');
  qs('btnReveal').classList.add('hidden');
  qs('btnNext').classList.remove('hidden');
  
  qs(`step${state.currentQuestion + 1}`).classList.remove('active');
  qs(`step${state.currentQuestion + 1}`).style.background = 'var(--accent-orange)';
  qs(`step${state.currentQuestion + 1}`).style.borderColor = 'var(--accent-orange)';
}

function nextQuestion() {
  showQuestion(state.currentQuestion + 1);
}

function showFeedback(type, message) {
  const fb = qs('feedback');
  fb.className = `feedback ${type}`;
  fb.innerHTML = message;
  fb.classList.remove('hidden');
}

function updateAttemptsInfo() {
  qs('attemptsInfo').innerHTML = `Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹ÎµÏ‚: <strong>${state.attempts}</strong> | 
    ${state.hintShown ? 'ğŸ’¡ Î¥Ï€ÏŒÎ´ÎµÎ¹Î¾Î· ÎµÎ¼Ï†Î±Î½Î¯ÏƒÏ„Î·ÎºÎµ' : 'ÎœÎµÏ„Î¬ Î±Ï€ÏŒ Î»Î¬Î¸Î¿Ï‚ â†’ Ï…Ï€ÏŒÎ´ÎµÎ¹Î¾Î·'}`;
}

function updateProgress(index) {
  for (let i = 1; i <= 7; i++) {
    const step = qs(`step${i}`);
    if (!step) continue;
    if (i < index + 1) {
      step.classList.add('done');
      step.classList.remove('active');
    } else if (i === index + 1) {
      step.classList.add('active');
      step.classList.remove('done');
    } else {
      step.classList.remove('active', 'done');
    }
  }
  
  qs('progressFill').style.width = `${(index / 7) * 100}%`;
  qs('progressText').textContent = `Î•ÏÏÏ„Î·Î¼Î± ${index + 1} Î±Ï€ÏŒ 7`;
}

function updatePhaseDisplay() {
  const phases = {
    'idle': 'Î‘Î½Î±Î¼Î¿Î½Î®',
    'to_equilibrium': 'â« Î ÏÎ¿Ï‚ Î˜.Î™.',
    'at_collision': 'ğŸ’¥ ÎšÎ¡ÎŸÎ¥Î£Î— ÏƒÏ„Î· Î˜.Î™.!',
    'post_collision': 'â¬â†— ÎœÎµÏ„Î¬ ÎºÏÎ¿ÏÏƒÎ·',
    'show_amplitude': 'ğŸ“ ÎÎ­Î¿ Ï€Î»Î¬Ï„Î¿Ï‚ Aâ‚',
    'to_detach': 'â« Î ÏÎ¿Ï‚ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·',
    'at_detach': 'âœ‚ï¸ Î‘Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ· ÏƒÏ„Î· Î¸.Ï†.Î¼.!',
    'to_meeting': 'ğŸ¯ ÎšÎ¯Î½Î·ÏƒÎ· Î²Î»Î·Î¼Î¬Ï„Ï‰Î½',
    'meeting_done': 'ğŸ’¥ Î£Ï…Î½Î¬Î½Ï„Î·ÏƒÎ·!'
  };
  qs('phaseDisplay').textContent = phases[state.animState] || state.animState;
}

/* =====================================================
   PHYSICS UPDATE
===================================================== */
function update(dt) {
  dt *= state.slowMotion;
  if (!state.running) return;
  
  const q = QUESTIONS[state.currentQuestion];
  if (!q) return;
  
  state.t += dt;
  
  switch (state.animState) {
    case 'to_equilibrium':
      // Î‘Î‘Î¤: x = -Aâ‚€Â·cos(Ï‰t)
      state.x = -A0 * Math.cos(OMEGA * state.t);
      state.v = A0 * OMEGA * Math.sin(OMEGA * state.t);
      
      if (q.freezeCondition()) {
        q.onFreeze();
        state.running = false;
        updatePhaseDisplay();
      }
      break;
      
    case 'post_collision':
    case 'show_amplitude':
      // ÎœÎµÏ„Î¬ ÎºÏÎ¿ÏÏƒÎ· - ÏƒÏÏƒÏ„Î·Î¼Î± Î‘Î‘Î¤ Î¼Îµ Aâ‚
      state.x = -A1 * Math.sin(OMEGA * state.t);
      state.v = -A1 * OMEGA * Math.cos(OMEGA * state.t);
      
      // Î’ÏŒÎ»Î¿Ï‚ - Î²Î¿Î»Î® Ï€ÏÎ¿Ï‚ Ï„Î± Ï€Î¬Î½Ï‰
      state.ballY = U3_AFTER * state.t - 0.5 * G * state.t * state.t;
      state.ballV = U3_AFTER - G * state.t;
      
      if (q.freezeCondition()) {
        q.onFreeze();
        state.running = false;
        updatePhaseDisplay();
      }
      break;
      
    case 'to_detach':
      // Î‘Ï€ÏŒ Î±ÎºÏÎ±Î¯Î¿ ÎºÎ¬Ï„Ï‰ Ï€ÏÎ¿Ï‚ Î¸.Ï†.Î¼.
      // x = -Aâ‚Â·cos(Ï‰t) Î¾ÎµÎºÎ¹Î½ÏÎ½Ï„Î±Ï‚ Î±Ï€ÏŒ -Aâ‚
      state.x = -A1 * Math.cos(OMEGA * state.t);
      state.v = A1 * OMEGA * Math.sin(OMEGA * state.t);
      
      // Î’ÏŒÎ»Î¿Ï‚ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ (Ï‡ÏÏŒÎ½Î¿Ï‚ Î±Ï€ÏŒ ÎºÏÎ¿ÏÏƒÎ· = T/4 + t)
      const tFromCollision = Math.PI / (2 * OMEGA) + state.t;
      state.ballY = U3_AFTER * tFromCollision - 0.5 * G * tFromCollision * tFromCollision;
      state.ballV = U3_AFTER - G * tFromCollision;
      
      if (q.freezeCondition()) {
        q.onFreeze();
        state.running = false;
        updatePhaseDisplay();
      }
      break;
      
    case 'to_meeting':
      // ÎœÎµÏ„Î¬ Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ· - ÎºÎµÏ†Î¬Î»Î¹ ÎºÎ±Î¹ Î²ÏŒÎ»Î¿Ï‚ Ï‰Ï‚ Î²Î»Î®Î¼Î±Ï„Î±
      const tDet = state.t;
      
      // ÎšÎµÏ†Î¬Î»Î¹
      state.headY = D + V_DETACH * tDet - 0.5 * G * tDet * tDet;
      state.headV = V_DETACH - G * tDet;
      
      // Î’ÏŒÎ»Î¿Ï‚ (ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Î±Ï€ÏŒ Ï„Î· Î¸Î­ÏƒÎ·/Ï„Î±Ï‡ÏÏ„Î·Ï„Î± Î±Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ·Ï‚)
      state.ballY = Y_BALL_AT_DETACH + V_BALL_AT_DETACH * tDet - 0.5 * G * tDet * tDet;
      state.ballV = V_BALL_AT_DETACH - G * tDet;
      
      // Î”Î¯ÏƒÎºÎ¿Ï‚ - Î‘Î‘Î¤ (Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎµÏ†Î¬Î»Î¹, Î½Î­Î± Î¹ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±)
      // Î‘Ï€Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·: ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Î¼Îµ Î¯Î´Î¹Î¿ Ï‰
      const tFromDetach = state.t;
      state.diskX = D * Math.cos(OMEGA * tFromDetach);
      state.diskV = -D * OMEGA * Math.sin(OMEGA * tFromDetach);
      
      if (q.freezeCondition()) {
        q.onFreeze();
        state.running = false;
        updatePhaseDisplay();
      }
      break;
  }
}

/* =====================================================
   DRAWING
===================================================== */
function yToPx(y) {
  return EQ_Y - y * PPM;
}

function draw() {
  ctx.clearRect(0, 0, W, H);
  
  // Î‘ÏƒÏ„Î­ÏÎ¹Î±
  ctx.fillStyle = 'rgba(255,255,255,0.04)';
  for (let i = 0; i < 40; i++) {
    ctx.fillRect((i * 137) % W, (i * 89) % H, 2, 2);
  }
  
  // Î“ÏÎ±Î¼Î¼Î­Ï‚ Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚
  drawLine(EQ_Y, '#4ECDC4', 'Î˜Î­ÏƒÎ· Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±Ï‚ (x=0)');
  drawLine(NAT_Y, '#FFD700', 'Î˜Î­ÏƒÎ· Î¦Ï…Ïƒ. ÎœÎ®ÎºÎ¿Ï…Ï‚ (x=d)');
  
  // ÎˆÎ´Î±Ï†Î¿Ï‚
  ctx.fillStyle = '#2a2a4a';
  ctx.fillRect(0, FLOOR_Y, W, H - FLOOR_Y);
  
  // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î¸Î­ÏƒÎ·Ï‚ Î´Î¯ÏƒÎºÎ¿Ï…
  let diskY;
  if (state.headDetached) {
    diskY = yToPx(state.diskX);
  } else {
    diskY = yToPx(state.x);
  }
  
  // Î•Î»Î±Ï„Î®ÏÎ¹Î±
  const spc = 55;
  drawSpring(CX - spc, FLOOR_Y, CX - spc, diskY + 15);
  drawSpring(CX + spc, FLOOR_Y, CX + spc, diskY + 15);
  
  // Î”Î¯ÏƒÎºÎ¿Ï‚
  const barW = 160, barH = 30;
  ctx.fillStyle = 'rgba(100, 100, 150, 0.9)';
  ctx.strokeStyle = 'rgba(255,255,255,0.4)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.roundRect(CX - barW/2, diskY - barH/2, barW, barH, 8);
  ctx.fill();
  ctx.stroke();
  
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.font = '13px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('mâ‚+mâ‚‚', CX, diskY + 5);
  
  // ÎšÎµÏ†Î¬Î»Î¹ ÎºÎ»ÏŒÎ¿Ï…Î½
  let headPxY;
  if (state.headDetached) {
    headPxY = yToPx(state.headY);
  } else {
    headPxY = diskY - barH/2 - 32;
  }
  drawClownHead(CX, headPxY);
  
  // Î’ÏŒÎ»Î¿Ï‚ - Î Î‘ÎÎ¤Î‘ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î±
// Î’ÏŒÎ»Î¿Ï‚ â€“ Ï€Î¿Ï„Î­ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ ÎºÎµÏ†Î¬Î»Î¹ (Î¿ÏÏ„Îµ Î³Î¹Î± 1 frame)
  let ballPxY;
  const HEAD_R = 28;
  const BALL_R = 20;

  if (!state.ballActive) {
    // Î ÏÎ¹Î½ ÎºÏÎ¿ÏÏƒÎ·: Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ ÏƒÏ„Î· Î˜.Î™., Î Î‘ÎÎ© Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÎ»ÏŒÎ¿Ï…Î½
    ballPxY = yToPx(0) - 90; // Î£Ï„Î±Î¸ÎµÏÎ¬ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Î˜.Î™.
  } else {
    // Î‘Î¼Î­ÏƒÏ‰Ï‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ (ÏƒÏ„Î¹Î³Î¼Î¹Î±Î¯Î±) ÎºÏÎ¿ÏÏƒÎ·, Î³Î¹Î± Ï€Î¿Î»Ï Î¼Î¹ÎºÏÏŒ Ï‡ÏÎ¿Î½Î¹ÎºÏŒ Î´Î¹Î¬ÏƒÏ„Î·Î¼Î±,
    // ÎºÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿Î½ Î²ÏŒÎ»Î¿ ÏƒÏ„Î· Î¸Î­ÏƒÎ· ÎµÏ€Î±Ï†Î®Ï‚ Î Î‘ÎÎ© Î±Ï€ÏŒ Ï„Î¿ ÎºÎµÏ†Î¬Î»Î¹ ÏÏƒÏ„Îµ Î½Î± Î¼Î· "Ï€ÎµÏÎ¬ÏƒÎµÎ¹" Î±Ï€ÏŒ ÎºÎ¬Ï„Ï‰ Î¿Ï€Ï„Î¹ÎºÎ¬.
    const justAfterCollision = (state.animState === 'post_collision' && state.t < 0.04 && state.ballY <= 0.06);
    const atCollisionFrame = (state.animState === 'at_collision');
    if (atCollisionFrame || justAfterCollision) {
      ballPxY = headPxY - HEAD_R - BALL_R - 2;
    } else {
      ballPxY = yToPx(state.ballY);
    }
  }
  drawBall(CX, ballPxY);
  
  // Î’Î­Î»Î· Ï„Î±Ï‡ÏÏ„Î·Ï„Î±Ï‚
  if (state.v !== 0 && !state.headDetached) {
    drawArrow(CX - 120, diskY, state.v, '#4ECDC4', 'Î£ÏÏƒÏ„Î·Î¼Î±');
  }
  if (state.ballActive && state.ballV !== 0) {
    drawArrow(CX + 100, ballPxY, state.ballV, '#FF6B6B', 'Î’ÏŒÎ»Î¿Ï‚');
  }
  if (state.headDetached && state.headV !== 0) {
    drawArrow(CX - 100, headPxY, state.headV, '#7ED321', 'ÎšÎµÏ†Î¬Î»Î¹');
  }
  if (state.headDetached) {
    drawArrow(CX - 120, diskY, state.diskV, '#4ECDC4', 'Î”Î¯ÏƒÎºÎ¿Ï‚');
  }
  
  // Î¤ÎµÎ»Î¹ÎºÎ® ÎµÎ¹ÎºÏŒÎ½Î± ÏƒÏ…Î½Î¬Î½Ï„Î·ÏƒÎ·Ï‚
  if (state.animState === 'meeting_done') {
    ctx.fillStyle = 'rgba(255, 215, 0, 0.25)';
    ctx.beginPath();
    ctx.arc(CX, yToPx(Y_MEET), 55, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#FFD700';
    ctx.font = 'bold 18px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ’¥ Î£Î¥ÎÎ‘ÎÎ¤Î—Î£Î—!', CX, yToPx(Y_MEET) - 70);
    // (no spoiler) Meeting height is revealed only via the quiz 'reveal answer' button.
}
}

function drawLine(y, color, label) {
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 5]);
  ctx.beginPath();
  ctx.moveTo(40, y);
  ctx.lineTo(W - 40, y);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle = color;
  ctx.font = '12px system-ui';
  ctx.textAlign = 'left';
  ctx.fillText(label, 50, y - 8);
}

function drawSpring(x1, y1, x2, y2) {
  const coils = 14, amp = 12;
  const len = Math.abs(y2 - y1);
  const nat = 150;
  
  ctx.strokeStyle = len < nat * 0.85 ? '#FF6B6B' : len > nat * 1.15 ? '#4ECDC4' : 'rgba(255,255,255,0.6)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  
  const dy = (y2 - y1) / coils;
  for (let i = 1; i < coils; i++) {
    ctx.lineTo(x1 + (i % 2 === 0 ? -amp : amp), y1 + dy * i);
  }
  ctx.lineTo(x2, y2);
  ctx.stroke();
  
  ctx.fillStyle = '#666';
  ctx.beginPath();
  ctx.arc(x1, y1, 6, 0, Math.PI * 2);
  ctx.arc(x2, y2, 6, 0, Math.PI * 2);
  ctx.fill();
}

function drawClownHead(cx, cy) {
  ctx.save();
  ctx.translate(cx, cy);
  
  const grad = ctx.createRadialGradient(0, -5, 5, 0, 0, 28);
  grad.addColorStop(0, '#FFE4C4');
  grad.addColorStop(1, '#FFD2A8');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(0, 0, 28, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#ff2d2d';
  ctx.beginPath();
  ctx.arc(0, 6, 9, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#121212';
  ctx.beginPath();
  ctx.arc(-11, -6, 4, 0, Math.PI * 2);
  ctx.arc(11, -6, 4, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.strokeStyle = '#ff4a7a';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(0, 6, 15, 0.2, Math.PI - 0.2);
  ctx.stroke();
  
  ctx.fillStyle = '#ff7a00';
  ctx.beginPath();
  ctx.arc(-22, -18, 11, 0, Math.PI * 2);
  ctx.arc(22, -18, 11, 0, Math.PI * 2);
  ctx.arc(0, -28, 11, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.font = 'bold 11px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('mâ‚‚', 0, 3);
  
  ctx.restore();
}

function drawBall(cx, cy) {
  ctx.save();
  ctx.translate(cx, cy);
  
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(3, 5, 18, 9, 0, 0, Math.PI * 2);
  ctx.fill();
  
  const grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, 20);
  grad.addColorStop(0, '#bbb');
  grad.addColorStop(0.5, '#888');
  grad.addColorStop(1, '#444');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(0, 0, 20, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.beginPath();
  ctx.arc(-7, -7, 6, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = 'white';
  ctx.font = 'bold 12px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('mâ‚ƒ', 0, 5);
  
  ctx.restore();
}

function drawArrow(x, y, v, color, label) {
  const scale = 12;
  const len = Math.min(Math.abs(v) * scale, 55);
  const dir = v > 0 ? -1 : 1;
  
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = 3;
  
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x, y + dir * len);
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(x, y + dir * (len + 8));
  ctx.lineTo(x - 6, y + dir * len);
  ctx.lineTo(x + 6, y + dir * len);
  ctx.closePath();
  ctx.fill();
  
  ctx.font = '11px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText(`${Math.abs(v).toFixed(1)} m/s`, x, y + dir * len + dir * 20);
}

/* =====================================================
   GAME LOOP
===================================================== */
let lastTime = 0;
function gameLoop(ts) {
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;
  
  update(dt);
  draw();
  
  requestAnimationFrame(gameLoop);
}

/* =====================================================
   EVENTS
===================================================== */
qs('btnStartGame').addEventListener('click', () => {
  qs('introModal').classList.add('hidden');
  showQuestion(0);
});

qs('btnCheck').addEventListener('click', checkAnswer);
qs('btnHint').addEventListener('click', showHint);
qs('btnReveal').addEventListener('click', revealAnswer);
qs('btnNext').addEventListener('click', nextQuestion);

qs('btnStart').addEventListener('click', () => {
  if (!state.running) {
    state.running = true;
  }
});

qs('btnReset').addEventListener('click', () => location.reload());

qs('quizInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    if (!qs('btnCheck').classList.contains('hidden')) checkAnswer();
    else if (!qs('btnNext').classList.contains('hidden')) nextQuestion();
  }
});

qs('btnPlayAgain').addEventListener('click', () => location.reload());

/* =====================================================
   END GAME
===================================================== */
function endGame() {
  state.animState = 'meeting_done';
  state.running = false;
  
  const maxScore = 140;
  const pct = Math.round((state.score / maxScore) * 100);
  
  let medal, title;
  if (pct >= 85) { medal = 'ğŸ¥‡'; title = 'ğŸ‰ Î•Î¾Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬!'; }
  else if (pct >= 70) { medal = 'ğŸ¥ˆ'; title = 'ğŸ‘ Î Î¿Î»Ï ÎºÎ±Î»Î¬!'; }
  else if (pct >= 50) { medal = 'ğŸ¥‰'; title = 'ğŸ’ª ÎšÎ±Î»Î® Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±!'; }
  else { medal = 'ğŸ“š'; title = 'ğŸ“– Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î¼ÎµÎ»Î­Ï„Î·'; }
  
  qs('endTitle').textContent = title;
  qs('endMedal').textContent = medal;
  
  qs('endResults').innerHTML = `
    <p style="font-size:14px;">Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±: <strong style="color:var(--accent-gold);font-size:18px;">${state.score}/${maxScore}</strong></p>
    <p>Î‘ÎºÏÎ¯Î²ÎµÎ¹Î±: <strong>${pct}%</strong></p>
  `;
  
  qs('endAnalysis').innerHTML = `
    <p style="font-size:12px;line-height:1.8;color:var(--muted);">
      â€¢ uâ‚€ = Ï‰Aâ‚€ = <strong>${U0.toFixed(1)} m/s</strong><br>
      â€¢ uâ‚' = <strong>${U1_AFTER.toFixed(2)} m/s</strong> (â†“), uâ‚ƒ' = <strong>${U3_AFTER.toFixed(2)} m/s</strong> (â†‘)<br>
      â€¢ Aâ‚ = <strong>${(A1*100).toFixed(1)} cm</strong><br>
      â€¢ Î‘Ï€Î¿ÎºÏŒÎ»Î»Î·ÏƒÎ· ÏƒÏ„Î· Î¸.Ï†.Î¼. (x = d = <strong>0.1 m</strong>)<br>
      â€¢ u<sub>Î±Ï€</sub> = <strong>${V_DETACH.toFixed(2)} m/s</strong><br>
      â€¢ t<sub>Î±Ï€Î¿Îº</sub> â‰ˆ <strong>0.38s</strong> (Ï€ÏÎ¿ÏƒÎ­Î³Î³Î¹ÏƒÎ·)<br>
      â€¢ Î£Ï…Î½Î¬Î½Ï„Î·ÏƒÎ·: y â‰ˆ <strong>${Y_MEET.toFixed(2)} m</strong> Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Î˜.Î™.<br>
    </p>
  `;
  
  qs('endModal').classList.remove('hidden');
}

/* =====================================================
   INIT
===================================================== */
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
